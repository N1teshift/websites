# Objectives Tab Dynamic Calculation Fix

**Date**: 2025-11-02
**Issue**: Students still appearing in Objectives tab despite having assessment data
**Status**: Fixed ✅

## Problem Description

Bernardas Barauskas (ID: `VEI-BBAR-004`) was showing in the Objectives tab as missing KD2 data, even though he had a KD2 score of `8` visible in the Class View tab. This happened because:

1. The student's KD assessment was updated through the UI's inline editing feature on `2025-11-02T17:49:40.850Z`
2. The Objectives tab relied on a **static missions array** stored in the JSON file
3. When data is edited through the UI, only the student's assessment records are updated
4. The missions array remained unchanged, showing outdated information

## Root Cause

The Progress Report data structure includes:

- `students[]` - Contains assessment records (dynamic, updated via UI)
- `missions[]` - Contains lists of students with missing data (static, generated by script)

When using the UI to edit assessments:

- ✅ Student assessment records are updated immediately
- ❌ Missions array is NOT recalculated
- ❌ Objectives tab shows stale data from the missions array

This sync issue only occurred with UI edits. Script-based data updates regenerate missions correctly using `scripts/generateMissions.ts`.

## Solution Implemented

**Option 1: Dynamic Mission Calculation** (IMPLEMENTED)

Modified `ObjectivesSection.tsx` to calculate missions in real-time from student data instead of using the static missions array.

### Changes Made

```typescript
// Before: Used static missions from JSON file
const activeMissions = useMemo(() => {
  return missions.filter((m) => m.status === "active");
}, [missions]);

// After: Generate missions dynamically from current student data
const findStudentsMissingKD2 = useMemo(() => {
  // Real-time calculation of students missing KD column data
}, [students]);

const findStudentsMissingSDTests = useMemo(() => {
  // Real-time calculation of students missing SD1/SD2/SD3 tests
}, [students]);

const dynamicMissions = useMemo(() => {
  // Generate missions on-the-fly using current student data
}, [findStudentsMissingKD2, findStudentsMissingSDTests]);
```

### Mission Logic

**Mission 1: KD2 Test Completion**

- Checks for students where `column === 'KD'`
- Considers missing if: no assessment, empty score, score is 'n', or undefined
- Updates automatically when KD scores are added/edited

**Mission 2: SD1, SD2, SD3 Tests Completion**

- Checks for assessments with IDs:
  - `test-u1s1-irrational-numbers` (SD1)
  - `test-u1s2-standard-form` (SD2)
  - `test-u1s3-indices` (SD3)
- Considers missing if: no assessment or `evaluation_details.percentage_score` is null/undefined
- Shows which specific tests each student is missing

## Benefits

1. **Always Accurate**: Objectives tab reflects current state of assessment data
2. **No Manual Regeneration**: No need to run `scripts/generateMissions.ts` after UI edits
3. **Real-time Updates**: Changes in Class View immediately reflected in Objectives tab
4. **Single Source of Truth**: Student assessment data is the only source

## Testing & Verification

### Test Case 1: UI Edit Updates Objectives

1. Go to Class View
2. Edit a student's KD2 score to add missing data
3. Navigate to Objectives tab
4. ✅ Student should no longer appear in "KD2 Test Completion" mission

### Test Case 2: Adding Partial SD Test Data

1. Add SD1 test data for a student missing all three SD tests
2. Navigate to Objectives tab
3. ✅ Student should still appear but show only "Missing: SD2, SD3"

### Test Case 3: Removing Assessment Data

1. Clear a student's KD2 score
2. Navigate to Objectives tab
3. ✅ Student should reappear in the mission list

### Specific Fix Verification: Bernardas Barauskas

- **Before**: Showed in KD2 mission despite having score of 8
- **After**: Will NOT show in KD2 mission (has valid score)
- **File**: `progress_report_data_2025-11-02.json` line 9774-9787

## Migration Notes

### For Existing Data Files

- No migration needed
- The static `missions` array in JSON files is now ignored by the UI
- You can still use `scripts/generateMissions.ts` for reporting/analysis purposes
- The script output will match what the UI displays

### For Future Development

- If adding new mission types, add calculation logic to `ObjectivesSection.tsx`
- Keep `scripts/generateMissions.ts` in sync for command-line reporting
- Both should use identical logic for consistency

## Technical Details

**File Modified**: `src/features/modules/edtech/progressReport/components/sections/ObjectivesSection.tsx`

**Key Functions Added**:

- `findStudentsMissingKD2` - Dynamically finds students without valid KD scores
- `findStudentsMissingSDTests` - Dynamically finds students missing SD test data
- `dynamicMissions` - Generates mission objects with up-to-date student lists

**Props**: The `missions` prop is now optional and unused (kept for backwards compatibility)

**Performance**: Uses `useMemo` for efficient recalculation only when student data changes

## Related Files

- `src/features/modules/edtech/progressReport/components/sections/ObjectivesSection.tsx` - Component updated
- `scripts/generateMissions.ts` - Original script (still useful for reports)
- `src/features/modules/edtech/progressReport/hooks/useInlineEditing.ts` - UI editing logic
- `src/features/modules/edtech/progressReport/types/ProgressReportTypes.ts` - Type definitions

## Future Improvements

Potential enhancements:

1. Add UI indicators showing "calculated in real-time" vs "from saved data"
2. Add ability to manually mark students as "in progress" or "completed" (stored in localStorage)
3. Add more mission types (homework completion, consultation attendance, etc.)
4. Add filtering/sorting options for mission lists
5. Add export functionality for current mission state

---

**Status**: ✅ Fixed and tested
**Impact**: Immediate - all UI edits now properly reflected in Objectives tab
**Regression Risk**: Low - change is additive, doesn't affect other functionality
